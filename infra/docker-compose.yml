services:
  mongo:
    image: mongo:7
    container_name: pageforge-mongo
    ports:
      - "27017:27017"
    volumes:
      - mongo-data:/data/db
    restart: unless-stopped

  redis:
    image: redis:7-alpine
    container_name: pageforge-redis
    ports:
      - "6379:6379"
    volumes:
      - redis-data:/data
    restart: unless-stopped
    command: redis-server --appendonly yes

  minio:
    image: minio/minio
    container_name: pageforge-minio
    ports:
      - "9000:9000"
      - "9001:9001"
    environment:
      MINIO_ROOT_USER: pageforge
      MINIO_ROOT_PASSWORD: pageforge-secret
    volumes:
      - minio-data:/data
    command: server /data --console-address ":9001"
    restart: unless-stopped

  caddy:
    image: caddy:2-alpine
    container_name: pageforge-caddy
    ports:
      - "80:80"
      - "443:443"
      - "2019:2019"
    volumes:
      - ./caddy.json:/etc/caddy/caddy.json
      - caddy-data:/data
      - caddy-config:/config
    command: caddy run --config /etc/caddy/caddy.json
    restart: unless-stopped

  # Cloudflare Tunnel â€” only starts with: --profile tunnel
  # Requires CLOUDFLARE_TUNNEL_TOKEN set in .env
  cloudflared:
    image: cloudflare/cloudflared:latest
    container_name: pageforge-tunnel
    profiles:
      - tunnel
    network_mode: host
    entrypoint: ["cloudflared", "--no-autoupdate", "tunnel", "run", "--token"]
    command: ["${CLOUDFLARE_TUNNEL_TOKEN}"]
    depends_on:
      - caddy
    restart: unless-stopped

volumes:
  mongo-data:
  redis-data:
  minio-data:
  caddy-data:
  caddy-config:
